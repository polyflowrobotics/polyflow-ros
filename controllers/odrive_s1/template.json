{
  "type": "controller",
  "name": "ODrive S1 Controller",
  "entry_point": "odrive_s1/node.py",
  "topics": [
    {
      "name": "/joint/state",
      "direction": "publish",
      "msg_type": "sensor_msgs/JointState",
      "qos": {
        "reliability": "best_effort",
        "history": "keep_last",
        "depth": 10
      }
    },
    {
      "name": "/joint_controller/command",
      "direction": "subscribe",
      "msg_type": "trajectory_msgs/JointTrajectory",
      "qos": {
        "reliability": "reliable",
        "history": "keep_last",
        "depth": 10
      }
    }
  ],
  "services": [],
  "actions": [],
  "parameters_schema": {
    "joint": {
      "label": "Joint",
      "requiresInstance": true,
      "type": "entity",
      "required": true,
      "description": "Joint ID this controller manages",
      "entity_source": {
        "selector": "components.outputs",
        "filters": {
          "output_type": "joint",
          "joint_type": "revolute,continuous"
        },
        "value_field": "_id",
        "label_field": "name"
      },
      "ui": { "group": "Joint", "order": 1 }
    },

    "control_mode": {
      "label": "Control Mode",
      "type": "enum",
      "values": ["velocity", "position", "torque"],
      "default": "position",
      "ui": { "group": "Control", "order": 2 }
    },

    "transport": {
      "label": "Transport",
      "type": "enum",
      "values": ["usb", "can"],
      "default": "can",
      "description": "How this node connects to the ODrive (USB via odrive python package, or CAN via python-can).",
      "ui": { "group": "Control", "order": 3 }
    },

    "units": {
      "label": "Units",
      "type": "enum",
      "values": ["radians", "turns"],
      "default": "radians",
      "description": "ROS JointTrajectory/JointState units. ODrive uses turns internally; this controls conversion scaling defaults.",
      "ui": { "group": "Control", "order": 4 }
    },

    "gear_ratio": {
      "label": "Gear Ratio",
      "type": "number",
      "default": 1.0,
      "description": "Gear ratio between motor and output (motor_turns = output_turns * gear_ratio). For example, 5.0 means the motor turns 5 times for each output turn.",
      "ui": { "group": "Control", "order": 5 }
    },

    "smoothing_alpha": {
      "label": "Smoothing Factor",
      "type": "number",
      "default": 0.0,
      "description": "Exponential smoothing factor (0.0 = no smoothing, 0.9 = heavy smoothing). Higher values create smoother motion but slower response. Recommended: 0.3-0.7 for smooth movements.",
      "ui": { "group": "Control", "order": 6 }
    },

    "can.node_id": {
      "label": "CAN Node ID",
      "type": "number",
      "default": 0,
      "description": "ODrive CAN node_id (axis.config.can.node_id).",
      "ui": { "group": "CAN", "order": 1 }
    },

    "can.interface": {
      "label": "CAN Interface",
      "type": "string",
      "default": "socketcan",
      "description": "python-can interface (e.g. socketcan).",
      "ui": { "group": "CAN", "order": 2 }
    },

    "can.channel": {
      "label": "CAN Channel",
      "type": "string",
      "default": "can0",
      "description": "CAN channel/device (e.g. can0).",
      "ui": { "group": "CAN", "order": 3 }
    },

    "can.bitrate": {
      "label": "CAN Bitrate",
      "type": "number",
      "default": 1000000,
      "description": "Optional bitrate for python-can (0 = use OS interface config).",
      "ui": { "group": "CAN", "order": 4 }
    },

    "can.poll_hz": {
      "label": "CAN Poll Rate (Hz)",
      "type": "number",
      "default": 50,
      "description": "Rate to request encoder estimates from ODrive.",
      "ui": { "group": "CAN", "order": 5 }
    },

    "can.request_iq": {
      "label": "CAN Request Iq",
      "type": "boolean",
      "default": false,
      "description": "If enabled, requests Iq feedback to estimate effort (requires can.torque_constant).",
      "ui": { "group": "CAN", "order": 6 }
    },

    "can.heartbeat_timeout_s": {
      "label": "CAN Heartbeat Timeout (s)",
      "type": "number",
      "default": 2.0,
      "description": "Warn if heartbeat isn't seen within this period after startup.",
      "ui": { "group": "CAN", "order": 7 }
    },

    "can.enable_closed_loop_on_start": {
      "label": "Enable Closed Loop On Start",
      "type": "boolean",
      "default": true,
      "description": "Sends AXIS_STATE_CLOSED_LOOP_CONTROL on startup (recommended for position/velocity control).",
      "ui": { "group": "CAN", "order": 8 }
    },

    "can.torque_constant": {
      "label": "Torque Constant (Nm/A)",
      "type": "number",
      "default": 0,
      "description": "If set and can.request_iq is enabled, effort is estimated as torque_constant * Iq_measured.",
      "ui": { "group": "CAN", "order": 9 }
    },

    "limit.lower_position": {
      "label": "Min. Rotation",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.lower_position"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 1 }
    },

    "limit.upper_position": {
      "label": "Max. Rotation",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.upper_position"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 2 }
    },

    "limit.position_step": {
      "label": "Rotation Step",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.position_step"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 3 }
    },

    "limit.max_effort": {
      "label": "Max Effort",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.max_effort"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 4 }
    },

    "limit.effort_step": {
      "label": "Effort Step",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.effort_step"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 5 }
    },

    "limit.max_velocity": {
      "label": "Max Velocity",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.max_velocity"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 6 }
    },

    "limit.velocity_step": {
      "label": "Velocity Step",
      "type": "number",
      "source": "entity_property",
      "binding": {
        "from_param": "joint",
        "field_path": "limit.velocity_step"
      },
      "editable": false,
      "ui": { "group": "Limits", "order": 7 }
    }
  },
  "defaults": {
    "namespace": "/robot/base",
    "rate_hz": 150,
    "lifecycle": true
  }
}
